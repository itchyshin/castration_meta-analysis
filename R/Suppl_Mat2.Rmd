---
title: "Castration extends lifespans of both male and female by 15%"
author: "Michael Garratt, Jean-François Lemaître, Malgrozata Lagisz & Shinichi Nakagawa"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
    
    rmdformats::readthedown:
      code_folding: hide
      code_download: true
editor_options: 
  chunk_output_type: console
# output:
#   html_document:
#     code_download: true
#     code_folding: hide
#     depth: 4
#     number_sections: no
#     theme:  cosmo # “default”, “cerulean”, “journal”, “flatly”, “darkly”, “readable”, “spacelab”, “united”, “cosmo”, “lumen”, “paper”, “sandstone”, “simplex”, “yeti”
#     toc: yes
  #   toc_float: yes
  #   toc_depth: 4
  # pdf_document:
  #   toc: yes
subtitle: Supplementary Material
#bibliography: references.bib
#biblio-style: "apalike"
#csl: ecol_lett.csl # we can change this
#link-citations: yes
#always_allow_html: true
---

```{r setup, include = FALSE}
#kniter seetting
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE, # no warnings
cache = TRUE,# Cacheing to save time when kniting
tidy = TRUE
#fig.width = 9
)

# clearning up
rm(list=ls())
```

# Setting-ups

## Loading packages

```{r}
# packages ####

#ochaRd
# 
# install.packages("devtools")
# install.packages("tidyverse")
# #install.packages("metafor")
# install.packages("patchwork")
# install.packages("R.rsp")
# 
# devtools::install_github("daniel1noble/orchaRd", force = TRUE, build_vignettes = TRUE)
# remotes::install_github("rvlenth/emmeans", dependencies = TRUE, build_opts = "") 
# 
# #emmeans
# remotes::install_github("rvlenth/emmeans", dependencies = TRUE, build_opts = "")
# # metafor
# install.packages("remotes")
# remotes::install_github("wviechtb/metafor")

# loading
pacman::p_load(tidyverse,
               metafor,
               pander,
               stringr,
               ape,
               here,
               kableExtra,
               patchwork,
               lme4,
               readxl,
               metaAidR,
               rotl,
               orchaRd,
               emmeans,
               clubSandwich,
               MuMIn,
               png,
               grid,
               here
)

# need for metafor to understand MuMin 
eval(metafor:::.MuMIn)
```

# Datasets

-   I will put two data sets here to show with meta-data

## Main dataset and meta-data

```{r, eval = FALSE}
# # getting the data and formating some variables (turning chraracter vectors to factors)
# read_csv(here("data/lit_search.csv"), na = "NA") %>%
#    mutate_if(is.character, as.factor) %>%  kable("html") %>%
#   kable_styling("striped", position = "left")
```

## Sub-dataset and meta-data

```{r, eval = FALSE}
# # getting the data and formating some variables (turning chraracter vectors to factors)
# full_data <- read_csv(here("data/2021-09-01-source-data-dat.csv"), na = "NA") %>% 
#    mutate_if(is.character, as.factor)
# 
# # dataset to compare the same cophylogenies between the two methods
# 
# full_pair <- read_csv(here("data/2020-08-12-paried.csv"), na = "NA") %>% 
#    mutate_if(is.character, as.factor)
# 
# # making a scrollable table
# kable(full_data, "html") %>%
#   kable_styling("striped", position = "left") %>%
#   scroll_box(width = "100%", height = "500px")
```

```{r}

```

## Data processing

### Functions for calculating effect size (lnRR)

```{r}
# custom functions 

# function for getting lnRR for proportional data (mortality)

lnrrp <- function(m1, m2, n1, n2) {
  # arcsine transforamtion
  asin_trans <- function(p) { asin(sqrt(p)) }
  # SD for arcsine distribution (see Wiki - https://en.wikipedia.org/wiki/Arcsine_distribution)
  var1 <- 1/8
  var2 <- 1/8
  # lnRR - with 2nd order correction
  lnrr <- log(asin_trans(m1)/asin_trans(m2)) + 
    0.5 * ((var1 / (n1 * asin_trans(m1)^2)) - (var2 / (n2 * asin_trans(m2)^2)))	
  
  var <- var1 / (n1 * asin_trans(m1)^2) + var1^2 / (2 * n1^2 * asin_trans(m1)^4)  + 
    var2 / (n2 * asin_trans(m2)^2) + var2^2 / (2 * n2^2 * asin_trans(m2)^4) 
  
  invisible(data.frame(yi = lnrr , vi = var))
}


# function to get to lnRR for longevity data (CV required)

lnrrm <- function(m1, m2, n1, n2, cv21, cv22) {
  # lnRR - with 2nd order correction
  lnrr <- log(m1/m2) + 
    0.5 * ((cv21 /n1) - (cv22 / n2))	
  
  var <- (cv21 / n1) + ((cv21^2) / (2 * n1^2))  + 
    (cv22/ n2) + ((cv22^2) / (2 * n2^2) )
  
  invisible(data.frame(yi = lnrr , vi = var))
}

```

### Main data

```{r}
#dat_full <- read_csv(here("data", "dat_07072021.csv"), na = c("", "NA")) 
#dat_full <- read_csv(here("data", "data_15022022.csv"), na = c("", "NA"))
dat_full <- read_csv(here("data", "data_19042022.csv"), na = c("", "NA"))
glimpse(dat_full)

#loading data ####
# TODO - ask Mike he sill wants to exclude "Vasectomy"
dat_full %>% filter(is.na(Treatment_lifespan_variable) == FALSE) %>% 
  filter(Type_of_sterilization != "Vasectomy") %>% 
  mutate_if(is.character, as.factor) -> dat


dim(dat)
dim(dat_full)
# separating two kinds

effect_type <- ifelse(str_detect(dat$Lifespan_parameter, "Me"), "longevity", "mortality")


# effect-level ID
dat$Species_Latin <- gsub("Macaca Fascicularis", "Macaca fascicularis", dat$Species_Latin) #fix a typo in species name
dat$Effect_ID <- 1:nrow(dat)
dat$Phylogeny <- sub(" ", "_",  dat$Species_Latin)
dat$Effect_type <- effect_type

# key variables
names(dat)
unique(dat$Species_Latin)
```

#### Calcuating effect size for the main data

```{r}
# let's get CVs

dat %>% group_by(Study) %>% summarise(cv2_cont = mean((Error_control_SD/Control_lifespan_variable)^2, na.rm = T), cv2_trt = mean((Error_experimental_SD/Treatment_lifespan_variable)^2, na.rm = T), cv2_opst = mean((Error_opposite_sex_SD/Opposite_sex_lifespan_variable)^2, na.rm = T), n_cont = mean(Sample_size_control, na.rm = T), n_trt =  mean(Sample_size_sterilization, na.rm = T), n_opst =  mean(Sample_size_opposite_sex, na.rm = T)) %>% 
  ungroup() %>% 
  summarise(cv2_cont = weighted.mean(cv2_cont, n_cont, na.rm = T), cv2_trt = weighted.mean(cv2_trt, n_trt, na.rm = T), cv2_opst = weighted.mean(cv2_opst, n_opst, na.rm = T)) -> cvs

# lnRR
# using CV
dat$yi <- ifelse(effect_type == "longevity", lnrrm(dat$Treatment_lifespan_variable, dat$Control_lifespan_variable, dat$Sample_size_sterilization, dat$Sample_size_control, cvs[["cv2_trt"]],cvs[["cv2_cont"]])[[1]], lnrrp(dat$Treatment_lifespan_variable, dat$Control_lifespan_variable, dat$Sample_size_sterilization, dat$Sample_size_control)[[1]])

dat$vi <- ifelse(effect_type == "longevity", lnrrm(dat$Treatment_lifespan_variable, dat$Control_lifespan_variable, dat$Sample_size_sterilization, dat$Sample_size_control, cvs[["cv2_trt"]],cvs[["cv2_cont"]])[[2]], lnrrp(dat$Treatment_lifespan_variable, dat$Control_lifespan_variable, dat$Sample_size_sterilization, dat$Sample_size_control)[[2]])

# getting effect size for the long format 
# we create a longer data format

dat1 <- dat
dat2 <- dat

dat1$yi <- ifelse(effect_type == "longevity", 
                  lnrrm(dat$Control_lifespan_variable,dat$Opposite_sex_lifespan_variable,  
                        dat$Sample_size_control, dat$Sample_size_opposite_sex, 
                        cvs[["cv2_cont"]],cvs[["cv2_opst"]])[[1]], 
                  lnrrp(dat$Control_lifespan_variable, dat$Opposite_sex_lifespan_variable, 
                        dat$Sample_size_control,  dat$Sample_size_opposite_sex)[[1]])

dat1$vi <-ifelse(effect_type == "longevity", 
                 lnrrm(dat$Control_lifespan_variable,dat$Opposite_sex_lifespan_variable,  
                       dat$Sample_size_control, dat$Sample_size_opposite_sex, 
                       cvs[["cv2_cont"]],cvs[["cv2_opst"]])[[2]], 
                 lnrrp(dat$Control_lifespan_variable, dat$Opposite_sex_lifespan_variable, 
                       dat$Sample_size_control,  dat$Sample_size_opposite_sex)[[2]])

# here we create CM/F or CF/M
dat2$yi <- ifelse(effect_type == "longevity", 
                  lnrrm(dat$Treatment_lifespan_variable, dat$Opposite_sex_lifespan_variable,
                        dat$Sample_size_sterilization, dat$Sample_size_opposite_sex, 
                        cvs[["cv2_trt"]],cvs[["cv2_opst"]])[[1]], 
                  lnrrp(dat$Treatment_lifespan_variable, dat$Opposite_sex_lifespan_variable, 
                        dat$Sample_size_sterilization, dat$Sample_size_opposite_sex)[[1]])

dat2$vi <- ifelse(effect_type == "longevity", 
                  lnrrm(dat$Treatment_lifespan_variable, dat$Opposite_sex_lifespan_variable,
                        dat$Sample_size_sterilization, dat$Sample_size_opposite_sex, 
                        cvs[["cv2_trt"]],cvs[["cv2_opst"]])[[2]], 
                  lnrrp(dat$Treatment_lifespan_variable, dat$Opposite_sex_lifespan_variable, 
                        dat$Sample_size_sterilization, dat$Sample_size_opposite_sex)[[2]])




# putting two data frames
dat_long <- rbind(dat1, dat2)

# putt 2 new column

dat_long$Obs <- factor(1:dim(dat_long)[[1]])
dat_long$Comp_type <- as.factor(rep(c("both_normal", "one_castrated"), each = dim(dat_long)[[1]]/2))


dim(dat_long)
```

### Sub-data

```{r}
sdat <- read_csv(here("data", "data2_15022022.csv"), na = c("", "NA")) 

effect_type_s <- ifelse(str_detect(sdat$Lifespan_parameter, "Me"), "longevity", "mortality")


# effect-level ID

sdat$Effect_ID <- 1:nrow(sdat)
sdat$Phylogeny <- sub(" ", "_",  sdat$Species_Latin)
sdat$Effect_type <- effect_type_s
```

#### Calcuating effect size

```{r}
# we create a longer data format

sdat1 <- sdat
sdat2 <- sdat
# lnRR

# here we create the ratio of F/M 
sdat1$yi <- ifelse(effect_type_s == "longevity", 
                  lnrrm(sdat$Female_control_lifespan_variable, sdat$Male_control_lifespan_variable,
                        sdat$Sample_size_female_control, sdat$Sample_size_male_control, 
                        cvs[["cv2_cont"]],cvs[["cv2_cont"]])[[1]], 
                  lnrrp(sdat$Female_control_lifespan_variable, sdat$Male_control_lifespan_variable, 
                        sdat$Sample_size_female_control,  sdat$Sample_size_male_control)[[1]])

sdat1$vi <- ifelse(effect_type_s == "longevity", 
                  lnrrm(sdat$Female_control_lifespan_variable, sdat$Male_control_lifespan_variable,
                        sdat$Sample_size_female_control, sdat$Sample_size_male_control, 
                        cvs[["cv2_cont"]],cvs[["cv2_cont"]])[[2]], 
                  lnrrp(sdat$Female_control_lifespan_variable, sdat$Male_control_lifespan_variable, 
                        sdat$Sample_size_female_control,  sdat$Sample_size_male_control)[[2]])

# here we create CF/CM
sdat2$yi <- ifelse(effect_type_s == "longevity", 
                  lnrrm(sdat$Female_sterilization_lifespan_variable, sdat$Male_sterilization_lifespan_variable,
                        sdat$Sample_size_female_sterilization, sdat$Sample_size_male_sterilization, 
                        cvs[["cv2_trt"]],cvs[["cv2_trt"]])[[1]], 
                  lnrrp(sdat$Female_sterilization_lifespan_variable, sdat$Male_sterilization_lifespan_variable, 
                        sdat$Sample_size_female_sterilization,  sdat$Sample_size_male_sterilization)[[1]])

sdat2$vi <-  ifelse(effect_type_s == "longevity", 
                   lnrrm(sdat$Female_sterilization_lifespan_variable, sdat$Male_sterilization_lifespan_variable,
                         sdat$Sample_size_female_sterilization, sdat$Sample_size_male_sterilization, 
                         cvs[["cv2_trt"]],cvs[["cv2_trt"]])[[2]], 
                   lnrrp(sdat$Female_sterilization_lifespan_variable, sdat$Male_sterilization_lifespan_variable, 
                         sdat$Sample_size_female_sterilization,  sdat$Sample_size_male_sterilization)[[2]])

# merging sdata frames
sdat_long <- rbind(sdat1, sdat2)

# putt 2 new column

sdat_long$Obs <- factor(1:dim(sdat_long)[[1]])
sdat_long$Comp_type <- as.factor(rep(c("both_normal", "both_castrated"), each = dim(sdat_long)[[1]]/2))

```

#### Building phylogenetic tree

```{r get species list, message = FALSE, echo = TRUE, eval = FALSE, warning = FALSE}
names(dat)
myspecies <- as.character(unique(dat$Species_Latin)) #get list of species
#str_sort(myspecies) #visual check
#length(myspecies) #23 species
#length(unique(myspecies)) #23 unique species names
```

Using *rotl* package to retrieve synthetic species tree from Open Tree of Life: Rotl is an R package (https://peerj.com/preprints/1471/) allowing access to synthetic phylogenetic tree available at Open Tree of Life database (https://opentreeoflife.org/).   

```{r rotl find species, message = FALSE, echo = TRUE, eval = FALSE, warning = FALSE}
taxa <- tnrs_match_names(names = myspecies)
dim(taxa) #40 specias - all matched
table(taxa$approximate_match) #1 approximate match
taxa[taxa$approximate_match == TRUE, ] ##lamperta fluviatilis (search_string) will be presented as Perca fluviatilis (uniquw_name)
```

Get the initial tree.  

```{r rotl species tree, warning = FALSE, results=FALSE, eval= FALSE, echo = TRUE}
tree <- tol_induced_subtree(ott_ids = taxa[["ott_id"]], label_format = "name")  
# plot(tree, cex=.6, label.offset =.1, no.margin = TRUE) visual check
```

Check matching species and labels.

```{r re-check tree labels, eval=F, echo=T}
#check overlap and differences with the taxa list
intersect(gsub("_"," ", tree$tip.label), myspecies) #22
setdiff(gsub("_"," ", tree$tip.label), myspecies) # "Perca fluviatilis"  
setdiff(myspecies, gsub("_"," ", tree$tip.label)) # "Lamperta fluviatilis"
tree$tip.label <- gsub("Perca_fluviatilis", "Lamperta_fluviatilis", tree$tip.label) #replace with the original name

#re-check overlap and differences with myspecies list
#intersect(myspecies, tree2$tip.label) #23
#setdiff(myspecies, tree2$tip.label) #0
#setdiff(tree2$tip.label, myspecies) #0

#check if the tree is really binary 
is.binary.tree(tree) #TRUE
# tree_binary$node.label <- NULL #you can delete internal node labels
# *NOTE:* no branch lengths are included, they can be created later via simulations.  

write.tree(tree, file=here("data", "tree_rotl.tre")) #save the tree

# *NOTE:* underscores within species names on tree tip labals are added automatically
# tree <- read.tree(file="plot_cooked_fish_MA.tre") #if you need to read in the tree
# tree$tip.label <- gsub("_"," ", tree$tip.label) #get rid of the underscores
# tree$node.label <- NULL #you can delete internal node labels
```

Plot phylogenetic tree

```{r plot phylogenetic tree, fig.width=10, fig.height=20, echo=TRUE, message=FALSE}
plot(tree, cex=.6, label.offset =.1, no.margin = TRUE)

# #or plot to pdf
# pdf(here("figs/rotl_tree.pdf"), width=8, heigh=10)
# plot(tree, cex=0.6, label.offset =.1, no.margin = TRUE)
# dev.off()
```


# Meta-analysis (the same sex contrasts)

## Main model

```{r}
# shared control 
# this does not seem to work
#V_matrix <- make_VCV_matrix(dat, V= "vi", cluster = "Shared_control", obs = "Effect_ID")

V_matrix <- impute_covariance_matrix(vi = dat$vi, cluster = dat$Shared_control, r = 0.5)

# phylogeny
#dat$Phylogeny <- gsub("Perca_fluviatilis", "Lamperta_fluviatilis", dat$Phylogeny) #replace with the original name
tree <- read.tree(here("data/tree_rotl.tre"))

tree <- compute.brlen(tree)
cor_tree <- vcv(tree, corr = TRUE)

# checking the match
match(unique(dat$Phylogeny), colnames(cor_tree))


# meta-analysis basics
# phylo model
mod <-  rma.mv(yi, V = V_matrix, mod = ~ 1, 
               random = list(~1|Phylogeny, 
                             ~1|Species_Latin, 
                             ~1|Study, 
                             ~1|Effect_ID), 
               R = list(Phylogeny = cor_tree), 
               data = dat, 
               test = "t",
               sparse = TRUE,
               control=list(optimizer="optim", optmethod="Nelder-Mead")
               )
summary(mod) 

i2_ml(mod) # almost no phylogenetic effect

    #     I2_Total     I2_Phylogeny I2_Species_Latin         I2_Study     I2_Effect_ID 
    # 99.465653956      0.000228903     44.565114981     34.127163402     20.773146669

orchard_plot(mod, xlab = "log response ratio (lnRR)", group = "Study", data = dat)

```

## Species-specific effects

```{r, eval=FALSE}
# getting blups (best linear predictors from the model)
# getting blups (best linear predictors from the model)
blups <- ranef(mod) 
t.spp <- blups$Species_Latin # this needs to be added
t.phy <- blups$Phylogeny 
t.study <- blups$Study # study
t.spp <- rownames_to_column(t.spp, var = "Species")
t.phy <- rownames_to_column(t.phy, var = "Species")
t.study <-  rownames_to_column(t.study, var = "Study") # study

# average cultivar
colnames(t.spp) <- c("Species", "Deviation", "SE", "Lower_bound", "Upper_bound")
colnames(t.phy) <- c("Species", "Deviation", "SE", "Lower_bound", "Upper_bound")
colnames(t.study) <- c("Study", "Deviation", "SE", "Lower_bound", "Upper_bound")

# sorting match between study and species
dat %>% group_by(Study) %>% summarise(Species_Latin = unique(Species_Latin)) -> dat_match

dat_match$Species_Latin 
index <- match(dat_match$Species_Latin , t.spp$Species)


# knitr::kable(t.cultivar) col.names = c(’Cultivar’,
# ’Deviation’, ’SE’, ’Lower bound’, ’Upper bound’))
spp.mean <- rep(mod$b, dim(t.spp)[1]) + t.spp$Deviation + t.phy$Deviation
spp.se <- sqrt(mod$se^2 + t.spp$SE^2 +  t.phy$SE^2) 
spp.lb <- spp.mean - spp.se * qnorm(0.975) 
spp.ub <- spp.mean + spp.se * qnorm(0.975)
t.spp2 <- tibble(Species = t.spp$Species, Mean = spp.mean, SE = spp.se, Lower_bound = spp.lb, Upper_bound = spp.ub) %>% arrange(Species)

# study wise 

study.mean <- rep(mod$b, dim(t.study)[1]) + t.spp$Deviation[index] + t.phy$Deviation[index] + t.study$Deviation
study.se <- sqrt(mod$se^2 + t.spp$SE[index]^2 +  t.phy$SE[index]^2 + t.study$SE^2) 
study.lb <- study.mean - study.se * qnorm(0.975) 
study.ub <- study.mean + study.se * qnorm(0.975)
t.study2 <- tibble(Study = t.study$Study, Species = t.spp$Species[index], 
                   Study_Spp = as.factor(paste(Study, Species, sep = "_")), Mean = study.mean, 
                   SE = study.se, Lower_bound = study.lb, Upper_bound = study.ub) %>% arrange(Species)

# plotting

# getting all photos 
# reading in photos
filenames <- list.files("icons", pattern=".png", full.names=TRUE)
ldf <- lapply(filenames, readPNG)
names(ldf) <- substr(filenames, 7, 60)
#name <- substr(filenames, 7, 60)


spp.plot <- ggplot(data = t.spp2, aes(x = Mean, y = Species)) +
  geom_errorbarh(aes(xmin = Lower_bound, xmax = Upper_bound),  
                 height = 0, show.legend = FALSE, size = 0.5, alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = 2, colour = "black", alpha = 0.5) +
  geom_vline(xintercept = mod$b, linetype = 1, colour = "red") +
  geom_point(aes(fill = Species), size = 3, shape = 21) + 
  xlim(-0, 0.25) +
  theme_bw() +
  labs(x = "lnRR (effect size)", y = "") + 
  theme(legend.position= c(0.99, 0.01), legend.justification = c(1, 0)) +
  theme(legend.title = element_text(size = 9)) +
  theme(legend.direction="horizontal") +
  theme(axis.text.y = element_blank()) +
  theme(axis.text.y = element_text(size = 10, colour ="black",
                                   hjust = 0.5)) +
  guides(fill = "none")  + 
  #annotation_custom(rasterGrob(ldf), xmin = rep(0.01, 14), xmax = rep(0.05, 14), ymin = seq(0.5, 13.5, 1), ymax = seq(1.5, 14.5, 1)) 
  annotation_custom(rasterGrob(ldf[[1]]), xmin = 0.01, xmax = 0.05, ymin = 0.5, ymax = 1.5) +
  annotation_custom(rasterGrob(ldf[[2]]), xmin = 0.01, xmax = 0.05, ymin = 1.5, ymax = 2.5) +
  annotation_custom(rasterGrob(ldf[[3]]), xmin = 0.01, xmax = 0.05, ymin = 2.5, ymax = 3.5) +
  annotation_custom(rasterGrob(ldf[[4]]), xmin = 0.01, xmax = 0.05, ymin = 3.5, ymax = 4.5) +
  annotation_custom(rasterGrob(ldf[[5]]), xmin = 0.01, xmax = 0.05, ymin = 4.5, ymax = 5.5) +
  annotation_custom(rasterGrob(ldf[[6]]), xmin = 0.01, xmax = 0.05, ymin = 5.5, ymax = 6.5) +
  annotation_custom(rasterGrob(ldf[[7]]), xmin = 0.01, xmax = 0.05, ymin = 6.5, ymax = 7.5) +
  annotation_custom(rasterGrob(ldf[[8]]), xmin = 0.01, xmax = 0.05, ymin = 7.5, ymax = 8.5) +
  annotation_custom(rasterGrob(ldf[[9]]), xmin = 0.01, xmax = 0.05, ymin = 8.5, ymax = 9.5) +
  annotation_custom(rasterGrob(ldf[[10]]), xmin = 0.01, xmax = 0.05, ymin = 9.5, ymax = 10.5) +
  annotation_custom(rasterGrob(ldf[[11]]), xmin = 0.01, xmax = 0.05, ymin = 10.5, ymax = 11.5) +
  annotation_custom(rasterGrob(ldf[[12]]), xmin = 0.01, xmax = 0.05, ymin = 11.5, ymax = 12.5) +
  annotation_custom(rasterGrob(ldf[[13]]), xmin = 0.01, xmax = 0.05, ymin = 12.5, ymax = 13.5) +
  annotation_custom(rasterGrob(ldf[[14]]), xmin = 0.01, xmax = 0.05, ymin = 13.5, ymax = 14.5)

spp.plot

# alternative way of inserting fig


```


```{r, fig.width= 20, fig.cap = "Species-specific effects: the red line indicates the overall effect - very little variation among species"}
knitr::include_graphics(here::here("figs", "fig_spp.png"))

#![Species-specific effects: the red line indicates the overall effect - very little variation among species](figs/fig_spp.png){width="100%"}
```

## Study-specific effect

```{r, eval = FALSE}
study.plot <- ggplot(data = t.study2, aes(x = Mean, y = fct_reorder(Study, Species))) +
  geom_errorbarh(aes(xmin = Lower_bound, xmax = Upper_bound),  
                 height = 0, show.legend = FALSE, size = 0.5, alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = 2, colour = "black", alpha = 0.5) +
  geom_vline(xintercept = mod$b, linetype = 1, colour = "red") +
  geom_point(aes(fill = Species), size = 3, shape = 21) + 
  xlim(-0.5, 0.8) +
  theme_bw() +
  labs(x = "lnRR (effect size)", y = "") + 
  theme(legend.position= c(0.99, 0.01), legend.justification = c(1, 0)) +
  theme(legend.title = element_text(size = 9)) +
  theme(legend.direction="horizontal") +
  theme(axis.text.y = element_blank()) +
  theme(axis.text.y = element_text(size = 10, colour ="black",
                                   hjust = 0.5)) +
  guides(fill = "none")  + 
  #annotation_custom(rasterGrob(ldf), xmin = rep(0.01, 14), xmax = rep(0.05, 14), ymin = seq(0.5, 13.5, 1), ymax = seq(1.5, 14.5, 1)) 
  annotation_custom(rasterGrob(ldf[[1]]), xmin = -0.5, xmax = -0.4, ymin = 1.5, ymax = 3.5) +
  annotation_custom(rasterGrob(ldf[[2]]), xmin = -0.45, xmax = -0.35, ymin = 3+ 4, ymax = 5 + 4) +
  annotation_custom(rasterGrob(ldf[[3]]), xmin = -0.5, xmax = -0.4, ymin = 0 + 12, ymax = 2 + 12) +
  annotation_custom(rasterGrob(ldf[[4]]), xmin = -0.45, xmax = -0.35, ymin = 2 + 14, ymax = 4 + 14) +
  annotation_custom(rasterGrob(ldf[[5]]), xmin = -0.5, xmax = -0.4, ymin = 2.5 + 18, ymax = 4.5 + 18) +
  annotation_custom(rasterGrob(ldf[[6]]), xmin = -0.45, xmax = -0.35, ymin = 0.5 + 23, ymax = 2.5 + 23) +
  annotation_custom(rasterGrob(ldf[[7]]), xmin = -0.5, xmax = -0.4, ymin = 4 + 25, ymax = 6 + 25) +
  annotation_custom(rasterGrob(ldf[[8]]), xmin = -0.45, xmax = -0.35, ymin = 0 + 35, ymax = 2 + 35) +
  annotation_custom(rasterGrob(ldf[[9]]), xmin = -0.5, xmax = -0.4, ymin = 0.5 + 36, ymax = 2.5 + 36) +
  annotation_custom(rasterGrob(ldf[[10]]), xmin = -0.45, xmax = -0.35, ymin = 0 + 38, ymax = 2 + 38) +
  annotation_custom(rasterGrob(ldf[[11]]), xmin = -0.5, xmax = -0.4, ymin = 0 + 39, ymax = 2+ 39) +
  annotation_custom(rasterGrob(ldf[[12]]), xmin = -0.45, xmax = -0.35, ymin = 0.5 + 40, ymax = 2.5 + 40) +
  annotation_custom(rasterGrob(ldf[[13]]), xmin = -0.5, xmax = -0.4, ymin = 3.5 + 42, ymax = 5.5 + 42) +
  annotation_custom(rasterGrob(ldf[[14]]), xmin = -0.45, xmax = -0.35, ymin = 0 + 49, ymax = 2 + 49)

study.plot

```

```{r,fig.width= 20, fig.cap = "Study-specific effects: the red line indicates the overall effect - much variation exist among studies"}
knitr::include_graphics(here::here("figs", "fig_study.png"))

#![Species-specific effects: the red line indicates the overall effect - very little variation among species](figs/fig_spp.png){width="100%"}
```

# Meta-regression (the same sex contrasts)

## Model function

```{r}

# very 

mod_func <-  function(formula) {
        rma.mv(yi, 
               V = V_matrix,
               mod = formula, 
               random = list(#~1|Phylogeny, 
                             ~1|Species_Latin, 
                             ~1|Study, 
                             ~1|Effect_ID), 
               #R = list(Phylogeny = cor_tree), 
               data = dat, 
               test = "t",
               sparse = TRUE,
               control=list(optimizer="optim", optmethod="BFGS")
               )
}

```


## Uni-moderator models {.tabset .tabset_fade .tabset_pills}

### Sex difference (`Sex`)

```{r}
mod_sex <- mod_func(formula = ~ Sex-1)
summary(mod_sex)
# contrast
mod_sex1 <- mod_func(formula = ~ Sex)
summary(mod_sex1)
r2_ml(mod_sex1)
# orchard plot
#test <- mod_results(mod_sex1, mod = "Sex", group = "Study", data = dat)
orchard_plot(mod_sex1, mod = "Sex", xlab = "log response ratio (lnRR)", group = "Study", data = dat, cb = F)
```

### Environmental (`Wild_or_semi_wild`)

```{r}
mod_env <- mod_func(formula = ~ Wild_or_semi_wild-1)
summary(mod_env)
# contrast
mod_env1 <- mod_func(formula = ~ Wild_or_semi_wild)
summary(mod_env1)
r2_ml(mod_env1)
# orchard plot
orchard_plot(mod_env1, mod = "Wild_or_semi_wild", xlab = "log response ratio (lnRR)", group = "Study", data = dat, cb = F)
```


### Environmental x Sex (`Sex_Env`)

```{r}
# TODO - not sure wehther we should include this
dat$Sex_Env <- paste(dat$Sex, dat$Wild_or_semi_wild, sep = "_")

mod_senv <- mod_func(formula = ~ Sex_Env-1)
summary(mod_env)
# contrast
mod_senv1 <- mod_func(formula = ~ Sex_Env)
summary(mod_senv1)
r2_ml(mod_senv1)
# orchard plot
orchard_plot(mod_senv1, mod = "Sex_Env", xlab = "log response ratio (lnRR)", group = "Study", data = dat, cb = F)
```


### Gonad Removal (`Sex_Gonads`)

```{r}
# creating a new variable Sex + Gonad because 

dat$Sex_Gonads <- paste(dat$Sex, dat$Gonads_removed, sep = "_")

dat$Sex_Gonads[grep("NA", dat$Sex_Gonads)] <- NA

mod_rem <- mod_func(formula = ~ Sex_Gonads-1)
summary(mod_rem)
# contrast
mod_rem1 <- mod_func(formula = ~ Sex_Gonads)
summary(mod_rem1)
r2_ml(mod_rem1)
# orchard plot
orchard_plot(mod_rem1, mod = "Sex_Gonads", xlab = "log response ratio (lnRR)", group = "Study", data = dat, cb = F)
```

### Controlled treatment (`Controlled_treatments`)

```{r}
mod_con <- mod_func(formula = ~ Controlled_treatments-1)
summary(mod_con)
# contrast
mod_con1 <- mod_func(formula = ~ Controlled_treatments)
summary(mod_con1)
r2_ml(mod_con1)
# orchard plot
orchard_plot(mod_con1, mod = "Controlled_treatments", xlab = "log response ratio (lnRR)", group = "Study", data = dat, cb = F)
```

### Controlled x Sex (`Sex_Cont`)

```{r}
# TODO - not sure whether we should include this
dat$Sex_Cont <- paste(dat$Sex, dat$Controlled_treatments, sep = "_")

mod_scont <- mod_func(formula = ~ Sex_Cont-1)
summary(mod_scont)
# contrast
mod_scont1 <- mod_func(formula = ~ Sex_Cont)
summary(mod_scont1)
r2_ml(mod_scont1)
# orchard plot
orchard_plot(mod_scont1, mod = "Sex_Cont", xlab = "log response ratio (lnRR)", group = "Study", data = dat, cb = F)
```

### Type of effect sizes (`Effect_type`)

```{r}
mod_eff <- mod_func(formula = ~ Effect_type-1)
summary(mod_eff)
# contrast
mod_eff1 <- mod_func(formula = ~ Effect_type)
summary(mod_eff1)
r2_ml(mod_eff1)
# orchard plot
orchard_plot(mod_eff1, mod = "Effect_type", xlab = "log response ratio (lnRR)", group = "Study", data = dat, cb = F)
```

### Matuarity (`Maturity_at_treatment_ordinal`)

```{r}
# just pure effect
mod_mat <- mod_func(formula = ~ Maturity_at_treatment_ordinal)
summary(mod_mat)
r2_ml(mod_mat)
# interaction with Sex
mod_sex_mat <- mod_func(formula = ~ Sex*Maturity_at_treatment_ordinal)
summary(mod_sex_mat)
r2_ml(mod_mat)
# bubble plot
get_data_raw_cont(mod_sex_mat, mod = "Maturity_at_treatment_ordinal", group = "Study", data = dat, by = "Sex")

#test <- mod_results(mod_sex_mat, mod = "Maturity_at_treatment_ordinal", group = "Study", data = dat, by = "Sex")
bubble_plot(test, mod = "Maturity_at_treatment_ordinal", group = "Study", data = dat, by = "Sex")#test2 <- mod_results(mod_sex_mat, mod = "Maturity_at_treatment_ordinal", data = dat, group = "Study")
bubble_plot(mod_mat, mod = "Maturity_at_treatment_ordinal", data = dat)
```

## Mulit-moderator models

### Full model

```{r}
# at least 10 in each group (sex * wild = male wild is too few - 4)

mod_full <- mod_func(formula = ~ Sex_Gonads + Sex*Controlled_treatments +  Wild_or_semi_wild + Sex*Maturity_at_treatment_ordinal)
summary(mod_full)
r2_ml(mod_full)
```

### AIC model selection

```{r, eval = F}

#res_mod_full <- dredge(mod_full, trace=2)
res_mod_full <- dredge(mod_full, trace=2)

saveRDS(res_mod_full, file = here("Rdata", "res_mod_full"))
```

```{r}
res_mod_full <- readRDS(file = here("Rdata", "res_mod_full"))

# delta AIC = 2
res_mod_full2<- subset(res_mod_full, delta <= 2, recalc.weights=FALSE)

# the best model according to the delta 2
best2 <- mod_func(formula = ~ Controlled_treatments + Wild_or_semi_wild)
summary(best2)

#
avg2 <- model.avg(res_mod_full2)
summary(avg2)

# note 
# controlling and wild-semi-wide is corelated: r = 0.34
cor.test(as.numeric(dat$Controlled_treatments),as.numeric(dat$Wild_or_semi_wild))

```

# Sensitivity analysis 

## Publication bais analysis {.tabset .tabset_fade .tabset_pills}

### Funnel plot

```{r}
# raw funnel plot
funnel(mod)

# residual funnel plot

funnel(best2)
#funnel(best6)

```


### Small-study effect: uni-moderaotor

```{r}

dat$Effective_N <- 1/dat$Sample_size_sterilization + 1/dat$Sample_size_control

egger_uni <- mod_func(formula = ~ sqrt(Effective_N))
egger_uni2 <- mod_func(formula = ~ Effective_N)

summary(egger_uni)
summary(egger_uni2)
```


### Decline effect (time lag bias): uni-moderator

```{r}

dat$Year <- as.numeric(str_extract(as.character(dat$Study),"[:digit:][:digit:][:digit:][:digit:]"))

decline_uni <- mod_func(formula = ~ Year)
summary(decline_uni)
```


### Mulit-moderator model for both the small-study & decline effects

```{r}

dat$cYear <- scale(dat$Year, scale = F)

pub_bias <- mod_func(formula = ~ Effective_N + Controlled_treatments + Wild_or_semi_wild + cYear)
  
summary(pub_bias)

prep <- qdrg(object = pub_bias, data = as.data.frame(dat), at = list(Effective_N = 0, cYear = 0))


# res<-marginal_means(model = pub_bias, data = dat, mod="1", weights = "prop") 
# res$mod_table

# equal averaging
res1 <- emmeans(prep, specs = "1", df = pub_bias$ddf, weights = "equal")
res1

# proportional to what we have 
res2 <- emmeans(prep, specs = "1", df = pub_bias$ddf, weights = "prop")
res2
```

## Leave-one-study-out analysis

```{r, eval = FALSE}
dat$Study <- as.factor(dat$Study)

LeaveOneOut_effectsize <- list()
for(i in 1:length(levels(dat$Study))){
  dat1 <- dat[dat$Study != levels(dat$Study)[i], ]
  V_matrix <- impute_covariance_matrix(vi = dat1$vi, cluster = dat1$Shared_control, r = 0.5)
  
  LeaveOneOut_effectsize[[i]] <- rma.mv(yi, 
               V = V_matrix,
               random = list(~1|Species_Latin, 
                             ~1|Study, 
                             ~1|Effect_ID), 
               test = "t",
               sparse = TRUE,
               control=list(optimizer="optim", optmethod="BFGS"),
               data = dat1)
  }


# writing function for extracting est, ci.lb, and ci.ub from all models
est.func <- function(mod){
  df <- data.frame(est = mod$b, lower = mod$ci.lb, upper = mod$ci.ub)
  return(df)
}

#using dplyr to form data frame
MA_LOO <- lapply(LeaveOneOut_effectsize, function(x) est.func(x))%>% bind_rows %>% mutate(left_out = levels(dat$Study))


saveRDS(MA_LOO,file = here("Rdata", "MA_LOO.rds"))
#telling ggplot to stop reordering factors
MA_LOO <- readRDS(file = here("Rdata", "MA_LOO.rds"))

MA_LOO$left_out<- as.factor(MA_LOO$left_out)
MA_LOO$left_out<-factor(MA_LOO$left_out, levels = MA_LOO$left_out)


#plotting
leaveoneout_E <- ggplot(MA_LOO) +
  geom_hline(yintercept = 0, lty = 2, lwd = 1) +
  geom_hline(yintercept = mod$ci.lb, lty = 3, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod$b, lty = 1, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod$ci.ub, lty = 3, lwd = 0.75, colour = "black") +
  geom_pointrange(aes(x = left_out, y = est, ymin = lower, ymax = upper)) +
  xlab("Study left out") + 
  ylab("lnRR, 95% CI") + 
  coord_flip() +
  theme(panel.grid.minor = element_blank())+
  theme_bw() + theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor.x = element_blank() ) +
  theme(axis.text.y = element_text(size = 6))

leaveoneout_E

```


# Meta-regression (different sex contrasts)

## Contrasts based different sexes {.tabset .tabset_fade .tabset_pills}

### Comparing M/F or F/M vs. M$\star$/F or F$\star$/M

```{r}
# variance covariance matrix
V_matrix_long <- impute_covariance_matrix(vi = dat_long$vi, cluster = dat_long$Shared_control, r = 0.5)

# we can run - some heteroscad models
# this does not improve model
mod_comp <-  rma.mv(yi, V = V_matrix_long, 
                 mod = ~ Comp_type - 1, random = list(~1|Species_Latin, ~1|Study, ~1|Effect_ID, ~1|Obs ), data = dat_long, test = "t")
summary(mod_comp) 

orchard_plot(mod_comp, mod = "Comp_type", xlab = "log response ratio (lnRR)", group = "Study", data = dat_long, cb = F)
```

### Separating by sex (M/F or F/M vs. M$\star$/F or F$\star$/M)

```{r}
# as interaction
dat_long$Comp_type_Sex <- paste(dat_long$Comp_type, dat_long$Sex, sep = "_")

mod_comp_sex <-  rma.mv(yi, V = vi, mod = ~ Comp_type_Sex -1 , random = list( ~1|Species_Latin, ~1|Study, ~1|Effect_ID, ~1|Obs ),data = dat_long, test = "t")
summary(mod_comp_sex) 

orchard_plot(mod_comp_sex, mod = "Comp_type_Sex", xlab = "log response ratio (lnRR)", group = "Study", data = dat_long, cb = F, angle = 45)
```

### Comparing F/M vs. F$\star$/M$\star$

```{r}
# VCV matrix
V_matrix_long <- impute_covariance_matrix(vi = sdat_long$vi, cluster = sdat_long$Shared_control, r = 0.5)

# correlaiton matrix for phylogeny
# tree <- read.tree(here("data/tree_rotl.tre"))
# tree <- compute.brlen(tree)
# cor_tree <- vcv(tree, corr = TRUE)

# this does not improve model
mod_comp2 <-  rma.mv(yi, V = V_matrix_long, mod = ~ Comp_type - 1, random = list( ~1|Species_Latin, ~1|Study, ~1|Effect_ID, ~1|Obs),data = sdat_long, test = "t")
summary(mod_comp2) 

orchard_plot(mod_comp2, mod = "Comp_type", xlab = "log response ratio (lnRR)", group = "Study", data = dat_long, cb = F, angle = 45)
```
